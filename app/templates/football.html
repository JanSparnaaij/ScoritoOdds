{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Football Matches</h1>
    
    <!-- League Selection -->
    <div class="league-selector mb-4">
        {% for league_id, league_url in leagues.items() %}
        <a href="{{ url_for('main.football', league=league_id) }}" 
           class="league-button {% if league_id == selected_league %}active{% endif %}">
            {{ league_id.replace('_', ' ').title() }}
        </a>
        {% endfor %}
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" style="display: {% if loading %}block{% else %}none{% endif %};">
        <p>Loading matches...</p>
        <div class="spinner"></div>
    </div>

    <!-- Matches Display -->
    <div id="matches-container">
        {% if matches %}
            <table class="match-table">
                <thead>
                    <tr>
                        <th>Home Team</th>
                        <th>Away Team</th>
                        <th>Home Win</th>
                        <th>Draw</th>
                        <th>Away Win</th>
                        <th>Best Bet</th>
                    </tr>
                </thead>
                <tbody>
                    {% for match in matches %}
                        {% set odds = [
                            (match.home_odds|float, 'Home Win'),
                            (match.draw_odds|float, 'Draw'),
                            (match.away_odds|float, 'Away Win')
                        ] %}
                        {% set best_odds = odds|sort|first %}
                        <tr>
                            <td>{{ match.home_team }}</td>
                            <td>{{ match.away_team }}</td>
                            <td class="{% if best_odds[1] == 'Home Win' %}highlight{% endif %}">
                                {{ match.home_odds }}
                            </td>
                            <td class="{% if best_odds[1] == 'Draw' %}highlight{% endif %}">
                                {{ match.draw_odds }}
                            </td>
                            <td class="{% if best_odds[1] == 'Away Win' %}highlight{% endif %}">
                                {{ match.away_odds }}
                            </td>
                            <td>{{ best_odds[1] }} ({{ best_odds[0]|round(2) }})</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p id="no-matches" {% if loading %}style="display: none;"{% endif %}>No matches available.</p>
        {% endif %}
    </div>
</div>

<style>
.match-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.match-table th,
.match-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.match-table th {
    background-color: #f4f4f4;
    font-weight: bold;
}

.match-table tr:hover {
    background-color: #f5f5f5;
}

.highlight {
    background-color: #e3f2fd;
    font-weight: bold;
    color: #1976d2;
}

.league-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}

.league-button {
    padding: 8px 16px;
    border: 1px solid #ddd;
    border-radius: 4px;
    text-decoration: none;
    color: #333;
    transition: all 0.3s ease;
}

.league-button:hover {
    background-color: #f0f0f0;
}

.league-button.active {
    background-color: #1976d2;
    color: white;
    border-color: #1976d2;
}

#loading-indicator {
    text-align: center;
    margin: 20px 0;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
function checkStatus() {
    if (!document.hidden) {  // Only check if page is visible
        fetch('/status/{{ selected_league }}')
            .then(response => response.json())
            .then(data => {
                console.log('Status response:', data);
                if (data.status === 'ready') {
                    console.log('Data ready, reloading page');
                    window.location.reload();
                } else {
                    setTimeout(checkStatus, 5000);
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
                setTimeout(checkStatus, 5000);
            });
    }
}

if (document.getElementById('loading-indicator').style.display === 'block') {
    console.log('Starting status check');
    checkStatus();
}
</script>
{% endblock %}
